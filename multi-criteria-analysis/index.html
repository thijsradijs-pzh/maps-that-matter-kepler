<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Stacked MCA Map</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/h3-js@3.7.2/dist/h3-js.umd.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>
  <script src="/shared/deckgl-utils.js"></script>
  <script src="/multi-criteria-analysis/config.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; background: #0a0a0a; }
    #container { width: 100vw; height: 100vh; position: relative; }
    #map-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center; z-index: 999;
    }
    #map-overlay.hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
    #map-overlay-content { background: white; padding: 40px; border-radius: 16px; text-align: center; max-width: 400px; }
    #controls {
      position: absolute; top: 20px; left: 20px; background: white;
      padding: 24px; border-radius: 12px; z-index: 1; width: 300px; max-height: 85vh; overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .control-group { margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
    .control-group:last-child { border: none; }
    .value-display { font-size: 18px; font-weight: bold; color: #333; float: right; }
    label { display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 4px; }
    input[type="range"] { width: 100%; cursor: pointer; height: 6px; border-radius: 3px; background: #ddd; outline: none; }
    
    /* Legend Styles */
    .legend-item { display: flex; align-items: center; margin-top: 4px; font-size: 12px; }
    .color-box { width: 12px; height: 12px; border-radius: 2px; margin-right: 8px; }
    
    #loading { position: absolute; top: 50%; left: 50%; color: white; transform: translate(-50%, -50%); }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="map-overlay">
    <div id="map-overlay-content">
      <h2 style="margin-top:0">ðŸ“Š Stacked 3D MCA</h2>
      <p style="color:#666">Each hexagon segment represents a specific criteria. Height represents the combined impact.</p>
      <button id="activate-btn" style="padding: 12px 28px; cursor: pointer; background: #333; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px;">Activate Map</button>
    </div>
  </div>
  <div id="loading">Loading binary matrix...</div>
  <div id="controls" style="display:none;"></div>

  <script>
    const {DeckGL} = deck;
    let deckInstance, allData = [], currentWeights = {};

    VIZ_CONFIG.filters.forEach(f => currentWeights[f.key] = f.default);

    function buildControls() {
      let html = `<h2 style="margin:0 0 20px 0; font-size:20px; color:#1a1a1a;">${VIZ_CONFIG.title}</h2>`;
      
      VIZ_CONFIG.filters.forEach((f, i) => {
        const color = VIZ_CONFIG.criteria[i].color;
        html += `
          <div class="control-group">
            <span class="value-display" id="${f.key}-display">${f.default}</span>
            <div class="legend-item">
              <div class="color-box" style="background: rgb(${color.join(',')})"></div>
              <label>${f.label}</label>
            </div>
            <input type="range" id="${f.key}-slider" min="${f.min}" max="${f.max}" step="${f.step}" value="${f.default}">
          </div>`;
      });
      return html;
    }

    function renderLayers() {
      if (!deckInstance) return;
      const layerConfigs = VIZ_CONFIG.createLayer(allData, currentWeights);
      const vizLayers = layerConfigs.map(config => DeckGLUtils.createH3Layer(config));
      
      deckInstance.setProps({
        layers: [
          DeckGLUtils.createBasemap(VIZ_CONFIG.basemap),
          ...vizLayers
        ]
      });
    }

    async function init() {
      try {
        allData = await DeckGLUtils.loadCSV(VIZ_CONFIG.dataUrl);
        document.getElementById('controls').innerHTML = buildControls();
        document.getElementById('controls').style.display = 'block';

        VIZ_CONFIG.filters.forEach(f => {
          document.getElementById(`${f.key}-slider`).addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            currentWeights[f.key] = val;
            document.getElementById(`${f.key}-display`).textContent = val;
            renderLayers();
          });
        });

        deckInstance = new DeckGL({
          container: 'container',
          initialViewState: VIZ_CONFIG.initialView,
          controller: false,
          layers: [],
          getTooltip: (info) => VIZ_CONFIG.tooltip(info)
        });

        document.getElementById('activate-btn').onclick = () => {
          document.getElementById('map-overlay').classList.add('hidden');
          deckInstance.setProps({ controller: true });
          renderLayers();
        };
        document.getElementById('loading').style.display = 'none';
      } catch (e) { console.error(e); }
    }
    init();
  </script>
</body>
</html>
