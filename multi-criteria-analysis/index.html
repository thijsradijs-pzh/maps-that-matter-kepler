<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Advanced Stacked MCA</title>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/h3-js@3.7.2/dist/h3-js.umd.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <script src="/shared/deckgl-utils.js"></script>
  <script src="/multi-criteria-analysis/config.js"></script>
  
  <style>
    body { margin: 0; background: #f0f0f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #container { width: 100vw; height: 100vh; position: relative; }
    #controls {
      position: absolute; top: 20px; right: 20px;
      background: rgba(255, 255, 255, 0.9); padding: 20px;
      border-radius: 12px; width: 280px; z-index: 10;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15); backdrop-filter: blur(8px);
    }
    .control-row { margin-bottom: 15px; color: #333; }
    .label-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-weight: 600; }
    .color-dot { width: 12px; height: 12px; border-radius: 3px; display: inline-block; margin-right: 8px; }
    input[type=range] { width: 100%; cursor: pointer; accent-color: #333; }
    .title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #000; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #666; }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="controls">
    <div class="title">ðŸ“Š Analyse Groene Hart Noord</div>
    <div style="font-size: 12px; color: #555; line-height: 1.5; margin-bottom: 15px; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 6px;">
    Deze interactieve kaart toont waar opgaven zoals bodemdaling, peilafwijkingen, wateroverlast en verzilting samenkomen. 
    Stel de weging per indicator in om de cumulatieve waardes van de thema's in dit gebied te visualiseren.
    </div>
    <div id="filter-list"></div>
  </div>
  <div id="loading">Processing Hexgrid...</div>

  <script>
    // Initialize Lighting from deck.gl
    const ambientLight = new deck.AmbientLight({ color: [255, 255, 255], intensity: 1.0 });
    const dirLight = new deck.DirectionalLight({
      color: [255, 255, 255],
      intensity: 1.5,
      direction: [-1, -2, -3]
    });
    const lightingEffect = new deck.LightingEffect({ ambientLight, dirLight });

    let deckInstance;
    let allData = [];
    const currentWeights = {};

    function renderLayers() {
      // Use your existing config to create layer properties
      const layerConfigs = VIZ_CONFIG.createLayer(allData, currentWeights);
      
      // Convert configs to actual H3Layers using your Utils
      const vizLayers = layerConfigs.map(config => DeckGLUtils.createH3Layer(config));
      
      deckInstance.setProps({
        layers: [
          DeckGLUtils.createBasemap(VIZ_CONFIG.basemap), // Restores the basemap
          ...vizLayers
        ]
      });
    }

    async function init() {
      try {
        // Use your Utils to load data
        allData = await DeckGLUtils.loadCSV(VIZ_CONFIG.dataUrl);
        document.getElementById('loading').style.display = 'none';

        // Build the UI
        const list = document.getElementById('filter-list');
        VIZ_CONFIG.filters.forEach(f => {
          currentWeights[f.key] = f.default;
          const crit = VIZ_CONFIG.criteria.find(c => c.weightKey === f.key);
          
          const row = document.createElement('div');
          row.className = 'control-row';
          row.innerHTML = `
            <div class="label-group">
              <span><span class="color-dot" style="background:rgb(${crit.color.join(',')})"></span>${crit.label}</span>
              <span id="${f.key}-display">${f.default}</span>
            </div>
            <input type="range" id="${f.key}-slider" min="${f.min}" max="${f.max}" step="${f.step}" value="${f.default}">
          `;
          list.appendChild(row);

          row.querySelector('input').addEventListener('input', (e) => {
            currentWeights[f.key] = parseInt(e.target.value);
            document.getElementById(`${f.key}-display`).textContent = e.target.value;
            renderLayers();
          });
        });

        // Create the Deck instance
        deckInstance = new deck.DeckGL({
          container: 'container',
          initialViewState: VIZ_CONFIG.initialView,
          controller: true,
          // effects: [lightingEffect],
          getTooltip: VIZ_CONFIG.tooltip
        });

        renderLayers();
      } catch (e) {
        console.error("Initialization failed:", e);
        document.getElementById('loading').textContent = "Error loading data.";
      }
    }

    init();
  </script>
</body>
</html>
