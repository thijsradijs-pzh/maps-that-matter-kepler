<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <title>Advanced Stacked MCA</title>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/h3-js@3.7.2/dist/h3-js.umd.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script> <script src="config.js"></script>
  
  <style>
    body { margin: 0; background: #111; font-family: 'Inter', sans-serif; color: white; }
    #container { width: 100vw; height: 100vh; }
    #controls {
      position: absolute; top: 20px; right: 20px;
      background: rgba(0, 0, 0, 0.85); padding: 20px;
      border-radius: 12px; width: 280px; z-index: 10;
      backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
    }
    .control-row { margin-bottom: 15px; }
    .label-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
    .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    input[type=range] { width: 100%; cursor: pointer; }
    .title { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #fff; }
    #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="controls">
    <div class="title">ðŸ“Š MCA Parameters</div>
    <div id="filter-list"></div>
  </div>
  <div id="loading">Loading Geospatial Data...</div>

  <script>
    const { DeckGL, H3HexagonLayer, AmbientLight, DirectionalLight, LightingEffect } = deck;

    // Create lighting effects
    const ambientLight = new AmbientLight({ color: [255, 255, 255], intensity: 1.0 });
    const dirLight = new DirectionalLight({
      color: [255, 255, 255],
      intensity: 2.0,
      direction: [-1, -2, -3]
    });
    const lightingEffect = new LightingEffect({ ambientLight, dirLight });

    let deckInstance;
    let allData = [];
    const currentWeights = {};

    function buildControls() {
      const list = document.getElementById('filter-list');
      VIZ_CONFIG.filters.forEach(f => {
        currentWeights[f.key] = f.default;
        const criterion = VIZ_CONFIG.criteria.find(c => c.weightKey === f.key);
        const color = criterion ? `rgb(${criterion.color.join(',')})` : '#fff';
        
        const row = document.createElement('div');
        row.className = 'control-row';
        row.innerHTML = `
          <div class="label-group">
            <span><span class="color-dot" style="background:${color}"></span>${criterion.label}</span>
            <span id="${f.key}-display">${f.default}</span>
          </div>
          <input type="range" id="${f.key}-slider" min="${f.min}" max="${f.max}" step="${f.step}" value="${f.default}">
        `;
        list.appendChild(row);

        row.querySelector('input').addEventListener('input', (e) => {
          const val = parseInt(e.target.value);
          currentWeights[f.key] = val;
          document.getElementById(`${f.key}-display`).textContent = val;
          renderLayers();
        });
      });
    }

    function renderLayers() {
      const layers = VIZ_CONFIG.createLayer(allData, currentWeights).map(props => new H3HexagonLayer(props));
      deckInstance.setProps({ layers });
    }

    async function init() {
      Papa.parse(VIZ_CONFIG.dataUrl, {
        download: true,
        header: true,
        complete: (results) => {
          allData = results.data;
          document.getElementById('loading').style.display = 'none';
          
          buildControls();
          
          deckInstance = new DeckGL({
            container: 'container',
            initialViewState: VIZ_CONFIG.initialView,
            controller: true,
            effects: [lightingEffect], // Add the 3D lighting here
            getTooltip: VIZ_CONFIG.tooltip
          });
          
          renderLayers();
        }
      });
    }

    init();
  </script>
</body>
</html>
