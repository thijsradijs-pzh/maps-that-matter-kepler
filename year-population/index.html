<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Population Over Time â€“ Maps That Matter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Uber font -->
    <link
      rel="stylesheet"
      href="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/uber-fonts/4.0.0/superfine.css"
    />

    <!-- Mapbox CSS (for basemap & controls) -->
    <link
      rel="stylesheet"
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css"
    />

    <!-- React / Redux / styled-components from CDN -->
    <script src="https://unpkg.com/react@16.8.4/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16.8.4/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/styled-components@4.1.3/dist/styled-components.min.js" crossorigin></script>

    <!-- Kepler.gl UMD build -->
    <script src="https://unpkg.com/kepler.gl@2.4.0/umd/keplergl.min.js"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        width: 100%;
      }

      #app {
        height: 100vh;
        width: 100vw;
      }

      /* Loading indicator */
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'ff-clan-web-pro', 'Helvetica Neue', Helvetica, sans-serif;
        color: #fff;
        font-size: 18px;
        z-index: 1000;
        text-align: center;
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid #fff;
        width: 40px;
        height: 40px;
        margin: 0 auto 10px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <script>
      const MAPBOX_TOKEN = ""; // Using Carto dark-matter basemap, no token needed
    </script>
  </head>
  <body>
    <div id="loading">
      <div class="spinner"></div>
      Loading map...
    </div>
    <div id="app"></div>

    <script>
      // --- CONFIGURATION ---
      const CONFIG = {
        dataFile: '../data/subset.csv',
        configFile: '../config/year_example.json',
        datasetId: '-g1xquc',  // CRITICAL: Must match dataId in config!
        datasetLabel: 'Population Over Time'
      };

      // --- REDUX STORE SETUP ---
      const reducers = Redux.combineReducers({
        keplerGl: KeplerGl.keplerGlReducer
      });

      const middlewares = KeplerGl.enhanceReduxMiddleware([]);
      const store = Redux.createStore(
        reducers,
        {},
        Redux.compose(Redux.applyMiddleware(...middlewares))
      );

      // --- REACT COMPONENT THAT RENDERS KEPLER ---
      function KeplerWrapper() {
        return React.createElement(
          "div",
          {
            style: {
              position: "absolute",
              left: 0,
              top: 0,
              width: "100vw",
              height: "100vh"
            }
          },
          React.createElement(KeplerGl.KeplerGl, {
            id: "map",
            mapboxApiAccessToken: MAPBOX_TOKEN,
            width: window.innerWidth,
            height: window.innerHeight
          })
        );
      }

      const app = React.createElement(
        ReactRedux.Provider,
        { store },
        React.createElement(KeplerWrapper, null)
      );

      ReactDOM.render(app, document.getElementById("app"));

      // --- AUTO-LOAD DATA + CONFIG ---
      const addDataToMap =
        (KeplerGl.actions && KeplerGl.actions.addDataToMap) ||
        KeplerGl.addDataToMap;

      // Robust CSV parsing function that handles edge cases
      function parseCSV(csvString) {
        // Normalize line endings
        const normalizedCsv = csvString.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        // Split into lines and filter out empty lines
        const lines = normalizedCsv.split('\n').filter(line => line.trim().length > 0);
        
        if (lines.length === 0) {
          console.error('CSV is empty');
          return { fields: [], rows: [] };
        }
        
        // Parse header
        const headers = lines[0].split(',').map(h => {
          const cleaned = h.trim();
          return cleaned || 'unknown'; // Replace empty headers with 'unknown'
        });
        
        console.log('CSV Headers:', headers);
        
        // Parse rows
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line.length === 0) continue; // Skip empty lines
          
          const values = line.split(',').map(v => v.trim());
          
          // Ensure row has correct number of columns
          if (values.length !== headers.length) {
            console.warn(`Row ${i} has ${values.length} columns, expected ${headers.length}. Skipping.`);
            continue;
          }
          
          // Replace empty values with empty string (not undefined)
          const cleanedValues = values.map(v => v || '');
          rows.push(cleanedValues);
        }
        
        console.log(`Parsed ${rows.length} rows with ${headers.length} columns`);
        
        // Verify we have data
        if (rows.length === 0) {
          throw new Error('No data rows found in CSV');
        }
        
        return { 
          fields: headers, 
          rows: rows 
        };
      }

      async function loadDataAndConfig() {
        try {
          console.log('=== Starting map load ===');
          console.log('Loading data from:', CONFIG.dataFile);
          
          // Load data file
          const dataResponse = await fetch(CONFIG.dataFile);
          if (!dataResponse.ok) {
            throw new Error(`Failed to load data: ${dataResponse.status} ${dataResponse.statusText}`);
          }
          const csvText = await dataResponse.text();
          console.log('Data loaded successfully, length:', csvText.length, 'characters');

          console.log('Loading config from:', CONFIG.configFile);
          
          // Load config file
          const configResponse = await fetch(CONFIG.configFile);
          if (!configResponse.ok) {
            throw new Error(`Failed to load config: ${configResponse.status} ${configResponse.statusText}`);
          }
          const configJson = await configResponse.json();
          console.log('Config loaded successfully');

          // Parse CSV data
          console.log('Parsing CSV...');
          const parsedData = parseCSV(csvText);
          console.log('CSV parsed successfully:');
          console.log('  - Fields:', parsedData.fields);
          console.log('  - Rows:', parsedData.rows.length);
          console.log('  - Sample row:', parsedData.rows[0]);

          // Create dataset object
          const dataset = {
            data: parsedData,
            info: {
              id: CONFIG.datasetId,
              label: CONFIG.datasetLabel
            }
          };

          console.log('Dispatching data to Kepler.gl with dataset ID:', CONFIG.datasetId);

          // Dispatch to Kepler.gl
          store.dispatch(
            addDataToMap({
              datasets: dataset,
              options: {
                centerMap: true,
                readOnly: false
              },
              config: configJson.config || configJson
            })
          );

          console.log('Data dispatched successfully');

          // Hide loading indicator after a short delay
          setTimeout(() => {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
              loadingEl.style.display = 'none';
            }
            console.log('=== Map loaded successfully! ===');
          }, 1500);

        } catch (err) {
          console.error("=== Error loading map ===");
          console.error(err);
          const loadingEl = document.getElementById('loading');
          if (loadingEl) {
            loadingEl.innerHTML = 
              `<div style="color: #ff6b6b; padding: 20px; max-width: 400px;">
                <strong>Error loading map</strong><br/>
                ${err.message}<br/>
                <small style="display: block; margin-top: 10px;">
                  Check browser console (F12) for detailed error information
                </small>
              </div>`;
          }
        }
      }

      // Start loading when page is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadDataAndConfig);
      } else {
        loadDataAndConfig();
      }
    </script>
  </body>
</html>
