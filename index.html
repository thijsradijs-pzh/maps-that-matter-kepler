<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Maps That Matter â€“ Interactive Map</title>

    <!-- Optional Uber font -->
    <link
      rel="stylesheet"
      href="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/uber-fonts/4.0.0/superfine.css"
    />

    <!-- Mapbox CSS (for basemap & controls) -->
    <link
      rel="stylesheet"
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css"
    />

    <!-- React / Redux / styled-components from CDN -->
    <script src="https://unpkg.com/react@16.8.4/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16.8.4/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/styled-components@4.1.3/dist/styled-components.min.js" crossorigin></script>

    <!-- Kepler.gl UMD build -->
    <script src="https://unpkg.com/kepler.gl@2.4.0/umd/keplergl.min.js"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        width: 100%;
      }

      #app {
        height: 100vh;
        width: 100vw;
      }
    </style>

    <!-- Your basemap is Carto "dark-matter" in the config, so token may be empty -->
    <script>
      const MAPBOX_TOKEN = ""; // put pk.xxx here if you ever switch to a Mapbox style
    </script>
  </head>
  <body>
    <div id="app"></div>

    <script>
      // --- REDUX STORE SETUP ---
      const reducers = Redux.combineReducers({
        keplerGl: KeplerGl.keplerGlReducer
      });

      const middlewares = KeplerGl.enhanceReduxMiddleware([]);
      const store = Redux.createStore(
        reducers,
        {},
        Redux.compose(Redux.applyMiddleware(...middlewares))
      );

      // --- REACT COMPONENT THAT RENDERS KEPLER ---
      function KeplerWrapper() {
        return React.createElement(
          "div",
          {
            style: {
              position: "absolute",
              left: 0,
              top: 0,
              width: "100vw",
              height: "100vh"
            }
          },
          React.createElement(KeplerGl.KeplerGl, {
            id: "map",
            mapboxApiAccessToken: MAPBOX_TOKEN,
            width: window.innerWidth,
            height: window.innerHeight
          })
        );
      }

      const app = React.createElement(
        ReactRedux.Provider,
        { store },
        React.createElement(KeplerWrapper, null)
      );

      ReactDOM.render(app, document.getElementById("app"));

      // --- AUTO-LOAD DATA + CONFIG ---

      const addDataToMap =
        (KeplerGl.actions && KeplerGl.actions.addDataToMap) ||
        KeplerGl.addDataToMap;

      const processors = KeplerGl.processors || {};
      const processCsvData = processors.processCsvData;

      async function loadDataAndConfig() {
        try {
          // ðŸ‘‰ new filenames
          const dataResponse = await fetch("data/subset.csv");
          const csvText = await dataResponse.text();

          const configResponse = await fetch("config/year_example.json");
          const configJson = await configResponse.json();

          const dataset = {
            data: processCsvData(csvText),
            info: {
              id: "qkkkoy", // must match dataId in your Kepler config
              label: "subset.csv"
            }
          };

          store.dispatch(
            addDataToMap({
              datasets: dataset,
              options: {
                centerMap: true,
                readOnly: false
              },
              config: configJson.config || configJson
            })
          );
        } catch (err) {
          console.error("Error loading data or config for Kepler map:", err);
        }
      }

      loadDataAndConfig();
    </script>
  </body>
</html>
